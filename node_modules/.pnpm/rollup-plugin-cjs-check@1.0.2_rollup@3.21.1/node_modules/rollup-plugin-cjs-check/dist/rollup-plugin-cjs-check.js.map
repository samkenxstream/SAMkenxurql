{"version":3,"file":"rollup-plugin-cjs-check.js","sources":["../src/index.mjs"],"sourcesContent":["import { parse, init } from 'cjs-module-lexer';\nimport { createFilter } from '@rollup/pluginutils';\n\nfunction cjsCheck(opts = {}) {\n  const filter = createFilter(opts.include, opts.exclude, {\n    resolve: false\n  });\n\n  return {\n    name: \"cjs-check\",\n\n    outputOptions(output) {\n      this.enabled = output.format === 'cjs' || output.format === 'umd';\n      return null;\n    },\n\n    async renderChunk(code, chunk) {\n      if (!this.enabled) {\n        return null;\n      } else if (!filter(chunk.fileName)) {\n        return null;\n      } else if (!chunk.exports || !chunk.exports.length) {\n        return null;\n      }\n\n      await init()\n\n      let output;\n      try {\n        output = parse(code);\n      } catch (error) {\n        this.warn(error);\n        return null;\n      }\n\n      const missingReexports = [];\n      const missingExports = [];\n\n      let hasMissing = false;\n      for (const mod of chunk.exports) {\n        if (mod[0] == '*' && !output.reexports.includes(mod.slice(1))) {\n          hasMissing = true;\n          missingReexports.push(mod.slice(1));\n        } else if (mod[0] != '*' && !output.exports.includes(mod)) {\n          hasMissing = true;\n          missingExports.push(mod);\n        }\n      }\n\n      if (hasMissing) {\n        let message = '';\n        if (missingReexports.length) {\n          message += 'The following re-exports are undetected:\\n';\n          message += missingReexports.map(x => `- ${x}\\n`).join('');\n        }\n\n        if (missingExports.length) {\n          message += 'The following exports are undetected:\\n';\n          message += missingExports.map(x => `- ${x}\\n`).join('');\n        }\n\n        if (missingExports.length + missingReexports.length >= chunk.exports.length) {\n          message = 'All chunk exports have not been detected. Is the chunk a CommonJS module?'\n        }\n\n        throw new Error(\n          `cjs-module-lexer did not agree with Rollup\\'s exports for ${chunk.fileName}.\\n${message}`\n        );\n      }\n\n      return null;\n    }\n  };\n}\n\nexport default cjsCheck;\n"],"names":["createFilter","init","parse"],"mappings":"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"}